name: MSK Bot Runner
concurrency:
  group: msk-bot-runner
  cancel-in-progress: true
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Bot Mode'
        type: choice
        required: true
        options:
          - normal
          - matchmaking
          # Adjust modes based on mskchess.ru capabilities
      tournament_id:
        description: 'Tournament ID (if applicable)'
        type: string
        required: false
      team_id:
        description: 'Team ID (optional)'
        type: string
        required: false
      password:
        description: 'Tournament password (optional)'
        type: string
        required: false
  schedule:
    - cron: '0 */6 * * *' # Run every 6 hours
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - 'config.yml'
permissions:
  actions: write
  contents: write
jobs:
  bot-runner:
    runs-on: ubuntu-latest
    timeout-minutes: 355 # Restart just before GitHub limit
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install tenacity pyyaml

      - name: Prepare Engine Directory
        run: |
          echo "Initializing engine storage..."
          mkdir -p engines
          sudo apt-get update && sudo apt-get install -y unzip curl

      - name: Fetch Latest Stockfish
        run: |
          # Adjust if mskchess.ru requires a specific engine
          chmod +x engines/stockfish || echo "Stockfish not found, proceeding..."

      - name: Acquire Fairy-Stockfish
        run: |
          echo "Obtaining the latest Fairy-Stockfish..."
          RUN_ID=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/fairy-stockfish/Fairy-Stockfish/actions/workflows/release.yml/runs?per_page=1&branch=master&status=success" \
            | jq -r '.workflow_runs[0].id')
          ARTIFACT_URL=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/fairy-stockfish/Fairy-Stockfish/actions/runs/$RUN_ID/artifacts" \
            | jq -r '.artifacts[] | select(.name | contains("linux-x86-64-modern")) | .archive_download_url')
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o fsf.zip "$ARTIFACT_URL"
          unzip -o fsf.zip -d engines/
          if [ -f engines/fairy-stockfish_x86-64-modern ]; then
            mv engines/fairy-stockfish_x86-64-modern engines/fsf-latest
          else
            echo "Fairy-Stockfish binary not found!"
            exit 1
          fi
          chmod +x engines/fsf-latest

      - name: Inject MSK Bot Token
        env:
          MSK_TOKEN: ${{ secrets.MSK_TOKEN }} # Renamed from LICHESS_TOKEN
        run: |
          python3 - << 'EOF'
          import os
          import yaml
          import sys

          token = os.getenv("MSK_TOKEN")
          if not token:
              print("ERROR: MSK_TOKEN secret is missing!")
              sys.exit(1)

          try:
              with open("config.yml", "r") as f:
                  config = yaml.safe_load(f) or {}
          except Exception as e:
              print(f"ERROR: Failed to read config.yml: {e}")
              sys.exit(1)

          config["token"] = token.strip() # Strip to handle any whitespace
          try:
              with open("config.yml", "w") as f:
                  yaml.safe_dump(config, f, default_flow_style=False)
              print("✅ Token injected successfully")
          except Exception as e:
              print(f"ERROR: Failed to write config.yml: {e}")
              sys.exit(1)
          EOF

      - name: Launch Bot
        run: |
          CMD_BASE="python3 -u user_interface.py"
          MODE="${{ github.event.inputs.mode }}"
          TOUR_ID="${{ github.event.inputs.tournament_id }}"
          TEAM_ID="${{ github.event.inputs.team_id }}"
          PASSWORD="${{ github.event.inputs.password }}"

          if [[ "$MODE" == "matchmaking" ]]; then
              CMD="$CMD_BASE matchmaking"
              echo "🤖 Running command: $CMD"
              eval "$CMD"
          elif [[ "$MODE" == "tournament" ]]; then
              if [[ -z "$TOUR_ID" ]]; then
                  echo "⚠️ Tournament ID missing. Skipping."
              else
                  ARGS="$TOUR_ID"
                  [[ -n "$TEAM_ID" ]] && ARGS="$ARGS $TEAM_ID"
                  [[ -n "$PASSWORD" ]] && ARGS="$ARGS $PASSWORD"
                  echo "🤖 Joining tournament: $ARGS"
                  eval "$CMD_BASE \"tournament $ARGS\""
              fi
          else
              echo "🤖 Running normal mode."
              eval "$CMD_BASE"
          fi

      - name: Auto-Restart After Timeout
        run: |
          BOT_PID=$!
          ( sleep 20700 && echo "⏰ Time's up. Restarting bot..." && kill -SIGTERM $BOT_PID ) &
          wait $BOT_PID
          echo "Bot ended cleanly."
