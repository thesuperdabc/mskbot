name: Run bot
on:
  workflow_dispatch:
  push:
    branches:
      - "main"
    paths:
      - "user_interface.py"
  schedule:
    - cron: "1 */5 * * *" # Every 5 hours
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Python Dependency Installation
        uses: py-actions/py-dependency-install@v4.0.0
      - name: Prepare Engine Permissions
        run: |
          if [ -f ./engines/stockfish ]; then
            chmod +x ./engines/stockfish
            echo "Stockfish ready"
          else
            echo "Error: stockfish not found"
            exit 1
          fi
          if [ -f ./engines/fsf-latest ]; then
            chmod +x ./engines/fsf-latest
            echo "Fairy-Stockfish ready"
          else
            echo "Warning: fsf-latest not found, skipping"
          fi
          ls -l ./engines/
      - name: Inject MSK Token
        run: |
          if [ -z "${{ secrets.MSK_TOKEN }}" ]; then
            echo "Error: MSK_TOKEN missing"
            exit 1
          fi
          sed -i "s/Token/${{ secrets.MSK_TOKEN }}/g" config.yml
          echo "token: \"${{ secrets.MSK_TOKEN }}\"" >> config.yml
          echo "# MSK Chess OAuth2 Token" >> config.yml
          echo "engines:" >> config.yml
          echo "  path: ./engines/stockfish" >> config.yml
          echo "Config updated"
      - name: Verify config.yml
        run: |
          cat config.yml || { echo "Error: config.yml missing"; exit 1; }
          if ! grep -q "^engines:" config.yml; then
            echo "Error: engines section missing"
            exit 1
          fi
          echo "Config verified"
      - name: Running the bot
        run: python user_interface.py
